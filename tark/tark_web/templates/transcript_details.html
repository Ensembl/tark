{% extends "web_home.html" %}

{% load staticfiles %}
{% load add_class %}
{% load compare_features %}
{% load sequence_format %}
{% load search_result_formatter %}


{% block content %}

<script type="text/javascript" class="init">


function get_query_params(row){

            transcript_stable_id = row.find("td:nth-child(3)").text().trim(); // Finds the 3rd <td> element
            transcript_assembly = row.find("td:nth-child(4)").text().trim(); 
            transcript_source = row.find("td:nth-child(5)").text().trim();
            
            
            transcript_release = row.find("td:nth-child(6)").text().trim(); 
            transcript_releases = [];
            if (typeof transcript_release != "undefined") {
            transcript_releases = transcript_release.split('..');
            transcript_releases_trimmed = [];
            $.each(transcript_releases, function( index, value ) {
			transcript_releases_trimmed.push(value.trim());
			});
            }
            console.log(transcript_releases_trimmed);
            transcript_release = transcript_releases_trimmed.sort().pop();

            //removing e and r from release
            if(transcript_release.startsWith("e") || transcript_release.startsWith("r")){
            transcript_release = transcript_release.substring(1,3);
            }else{
            transcript_release = transcript_release.substring(0,2);
            }
            return [transcript_stable_id, transcript_assembly, transcript_source, transcript_release];
}

function get_diff_result_summary(payload_data){

       
		//initialize diff_me
        diff_me_stable_id = payload_data['transcript1_stable_id'];
        diff_me_assembly = payload_data['transcript1_assembly'];
        diff_me_source = payload_data['transcript1_source'];
        diff_me_release = payload_data['transcript1_release'];
        
        //initialize diff with
        diff_with_stable_id = payload_data['transcript2_stable_id'];
        diff_with_assembly = payload_data['transcript2_assembly'];
        diff_with_source = payload_data['transcript2_source'];
        diff_with_release = payload_data['transcript2_release'];
        

        //collect diff_me params
        console.log('diff_me_assembly ' + diff_me_assembly + ' diff_me_source ' + diff_me_source  + ' diff_me_release ' + diff_me_release  + '  diff_me_stable_id ' +  diff_me_stable_id);
        
        //collect diff_with params
        console.log('diff_with_assembly ' + diff_with_assembly + ' diff_with_source ' + diff_with_source  + ' diff_with_release ' + diff_with_release  + '  diff_with_stable_id ' +  diff_with_stable_id);

        var root_url = "/api/transcript/diff/?";
        var diff_me_url = 'diff_me_assembly=' + diff_me_assembly + '&diff_me_source=' + diff_me_source  + '&diff_me_release=' + diff_me_release  + '&diff_me_stable_id=' + diff_me_stable_id;
        var diff_with_url = 'diff_with_assembly=' + diff_with_assembly + '&diff_with_source=' + diff_with_source  + '&diff_with_release=' + diff_with_release  + '&diff_with_stable_id=' + diff_with_stable_id;
        
        var get_url = root_url + diff_me_url + '&' + diff_with_url;
        get_url = get_url + "&render_as_string=True";
        var header_div = '<div id="current_well" class="well well-sm text-center" style="padding:5px;background-color: #d9edf7 !important;">' + 
        				 '<strong>TRANSCRIPT DIFF SUMMARY REPORT</strong>' +
         				'<button type="submit" id="close_diff_report" class="btn btn-default btn-sm" style="float:right;padding: 5px; font-size: 10px; line-height: 1.0;"><span class="glyphicon glyphicon-remove"></span> Close</button></div>';
        $.get(get_url, function(diff_data, status){
    		gene_table = diff_data["gene"];
    		transcript_table = diff_data["transcript"];
    		translation_table = diff_data["translation"];
    		exonset_table = diff_data["exonset"];

    		$('#summary_diff_qs1_qs2').html(header_div +  transcript_table + gene_table + translation_table + exonset_table);
    		$("#loadingSpinner_qs1_qs2").hide();
 		});

}//end get_diff_result_summary


function get_payload_data(row, transcript){
	payload_data = {};
  [transcript_stable_id, transcript_assembly, transcript_source, transcript_release] = get_query_params(row);
            payload_data[transcript + '_stable_id'] = transcript_stable_id;
      		payload_data[transcript + '_assembly'] = transcript_assembly;
      		payload_data[transcript + '_source'] = transcript_source;
      		payload_data[transcript + '_release'] = transcript_release;
      		console.log("===start get_payload_data ==");
      		console.log(payload_data);
      		console.log("===end get_payload_data ==");
      		
			return payload_data;
}

$(document).ready(function() {
  
    var search_table = $('#search_result_table').DataTable(
    { 
     "initComplete": function(settings){
  
            /* Apply the tooltips */
            $('#search_result_table thead th[title]').tooltip(
            {
               "container": 'body'
            });          
        },
        "pageLength": 25,
   // "order": [[ 3, "desc" ]],
    "columnDefs": [ {
      "targets"  : 'no-sort',
      "orderable": false,
    	}],
    	"language": {
        "emptyTable": "No results found for query <strong>{{search_identifier }}</strong>. Please try again with different identifier or without the version."
        }
    });
    
    $('#loadingSpinner_qs1_qs2').hide();
     
     var payload_data = {};
     var payload_data_tr1 = {};

    $('#search_result_table tbody').on('click', 'input[name*="transcript1"]', function(e){
        if( $(this).is(":checked") ){ // check if the radio is checked
            var row = $(this).parent().parent();
            payload_data_tr1 = get_payload_data(row, 'transcript1');
         }
    });
    
    var payload_data_tr2 = {};
     $('#search_result_table tbody').on('click', 'input[name*="transcript2"]', function(e){
        if( $(this).is(":checked") ){ // check if the radio is checked
            var row = $(this).parent().parent();   
            payload_data_tr2 = get_payload_data(row, 'transcript2');
        }
    });
    
    
    var payload_data ={};
    $("#search_diff_transcript").click(function (e) {
         payload_data = Object.assign({}, payload_data_tr1, payload_data_tr2);
        var transcript1_stable_id = payload_data['transcript1_stable_id'];
        var transcript2_stable_id = payload_data['transcript2_stable_id'];
       
      if(transcript1_stable_id && transcript2_stable_id){
      console.log("Two transcripts selected");
       $("#loadingSpinner_qs1_qs2").show();
      get_diff_result_summary(payload_data);
       }else{
       console.log("Two transcripts NOT selected");
       $('#myModal').modal('show');
      }
      });

 	// Add event listener for closing result table
 	$("#summary_diff_qs1_qs2").on("click", "#close_diff_report", function () {
       $("#summary_diff_qs1_qs2").empty();
     });
         
    
   });

	</script>



<div class="container" style="padding-top:20px;">

<div id="current_well" class="well well-sm" style="background-color: #303952;color:#ffffff"><strong>TRANSCRIPT DETAILS</strong></div>

<div class="row">
<div class="col-md-12">
<table class="table table-condensed">
<tr><td style="border-top: 0px;">StableID.version</td><td style="border-top: 0px;"><strong>{{transcript_details.stable_id}}.{{transcript_details.stable_id_version}}</strong></td></tr>
<tr><td>Assembly</td><td>{{transcript_details.assembly}}</td></tr>

{% with transcript_details.transcript_release_set.0 as release_info %}
<tr><td>Release</td><td>{{release_info.source}} {{release_info.shortname}} ({{ release_info.release_date }})</td></tr>
{% endwith %}

<tr><td>Transcript Location</td><td>Chromosome {{transcript_details.loc_region}}:{{transcript_details.loc_start}}..{{transcript_details.loc_end}} {% if transcript_details.loc_strand == 1 %} Forward {% else %} Reverse {% endif %} strand </td></tr>
{% with transcript_details.genes.0 as gene %}
<tr><td>Gene</td><td>{{gene.stable_id}}.{{gene.stable_id_version}} (<strong> {{ gene.name }} </strong>)</td></tr>
<tr><td>Gene Location</td><td>Chromosome {{gene.loc_region}}:{{gene.loc_start}}..{{gene.loc_end}} {% if gene.loc_strand == 1 %} Forward {% else %} Reverse {% endif %} strand </td></tr>
{% endwith %}

{% if transcript_details.mane_transcript %}
<tr><td>MANE Transcript</td><td>{{transcript_details.mane_transcript}} ({{ transcript_details.mane_transcript_type }})</td></tr>
{% endif %}

</table>
</div>
</div>

<div id="current_well" class="well well-sm" style="background-color: #303952;color:#ffffff"><strong>TRANSCRIPT HISTORY</strong></div>

<div class="row">
<div class="col-md-12">
<table id="search_result_table" class="table table-striped table-bordered table-responsive table-condensed">
<thead>
<tr style="background-color: #4b6584;color:#ffffff">
<th class="text-center" data-sortable="false">T1</th>
<th class="text-center" data-sortable="false">T2</th>
<th class="text-center" data-sortable="false">StableID.version</th>
<th class="text-center" data-sortable="false">Assembly</th>
<th class="text-center" data-sortable="false">Source</th>
<th class="text-center" data-sortable="false">Release</th>
<th class="text-center" data-sortable="false">Location</th>
<th class="text-center" data-sortable="true">MANE</th>
<th class="text-center" data-sortable="true">MANE_TYPE</th>
</tr>
</thead>
<tbody>
{% for transcript in transcript_history %}
<tr>
<td class="text-center"><input type="radio" name="transcript1"></td>
<td class="text-center"><input type="radio" name="transcript2"></td>
<td>{{ transcript.stable_id }}.{{ transcript.stable_id_version }}</td>
<td>{{transcript.assembly}}</td>
{% with transcript_details.transcript_release_set.0 as release_info %}
<td>{{release_info.source}}</td>
<td>
 {% with transcript.transcript_release_set|format_release_set:"{{release_info.source|lower}}" as release_date %}
 {{ release_date.date_range }}
 {% endwith %}
</td>
 {% endwith %}
<td>{{transcript.loc_region}}:{{transcript.loc_start}}..{{transcript.loc_end}}</td>
<td>{{transcript.mane_transcript}}</td>
<td>{{transcript.mane_transcript_type}}</td>


</tr>

{% endfor %}
</tbody>

</table>
</div>
</div>

<button type="submit" id="search_diff_transcript" class="btn btn-info">Diff Transcripts</button>
<a id="search_button" class="btn btn-primary" href="/web/search_link/{{ search_identifier }}"> Back to Search Results</a>

<!--modal-->
 <div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog modal-sm">
    
      <div class="modal-content">
        <div class="modal-header" style="background-color:#dc3545;color:#fff">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Warning!</h4>
        </div>
        <div class="modal-body">
          <p>Please select two transcripts to compare.</p>
        </div>
         <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
      
    </div>
  </div>

<!--modal-->


<!--summary-->
 <div id="loadingSpinner_qs1_qs2"><strong>Loading, please wait... </strong><img id="loading-img" src="{% static '/images/ajax-loader.gif' %}"><p></p></div>
 <div id="summary_diff_qs1_qs2" style="padding-top:20px;">  </div>

</div>
  
{% endblock %}