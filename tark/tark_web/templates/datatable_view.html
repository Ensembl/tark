{% extends "web_home.html" %}

{% block title %}DataTable{% endblock %}

{% load staticfiles %}
{% load add_class %}

{% block extra_styles %}
{% endblock %}

{% block extra_scripts %}
<script type="text/javascript">


function create_current_release_table(id_data_table, table_name_, assembly_name_, release_name_){
    console.log(id_data_table + "  " + table_name_ + "  " + assembly_name_ + "  " + release_name_);
 //datatable
    var tark_table = $('#'+id_data_table).DataTable( {

        "initComplete": function(settings, json) {
         $('#loadingSpinner').hide();
         $('#loadingSpinner_compare_with').hide();
         $('#compare_with_div').show();
          $('#select_transcript_compare_well').show();
         

        },
        "serverSide": {{server_side_processing}},
        "pageLength": 5,
        "lengthMenu": [[5, 10, 25, 50], [5, 10, 25, 50]],
        {% if server_side_processing == 'true' %}
        "ajax": "/web/datatable_serverside/" + table_name_ + "/" + assembly_name_ + "/" + release_name_ + "/",
        {% else %}
         "ajax": "/web/datatable_clientside/" + table_name_ + "/" + assembly_name_ + "/" + release_name_ + "/",
        {% endif %}
        
       "data":{'serverSide':{{ server_side_processing }} },
        columnDefs: [ {
            orderable: false,
            className: 'select-checkbox',
            targets:   0
        } ],
        select: {
            style:    'os',
            selector: 'td:first-child'
        },
        aoColumns: [
            { "mData": "", sDefaultContent: "" },
            {% for fields in data_fields %}
  			{ "mData": "{{ fields }}", sDefaultContent: "" },
  	        {% endfor %}
		],
    } );
    
    return tark_table;
 
}//end function


    $(document).ready(function() {
     $('#select_transcript_compare_well').hide();
     var original_state_compare_well = $("#select_transcript_compare_well").clone();
     
     var tark_table = create_current_release_table("tark_datatable","{{table_name}}", "{{assembly_name}}", "{{release_name}}" );
     var tark_table_compare = create_current_release_table("tark_datatable_compare_with","{{table_name}}", "{{assembly_name_compare}}", "{{release_name_compare}}" );

     $("#id_diff_with_assembly").change(function () {
       var assembly_releases = {{ all_assembly_releases|safe|escape }};
       var cur_assembly_name = $(this).val(); 

        var releases = assembly_releases[cur_assembly_name] || [];
        var options = $.map(releases, function(release){
            return '<option value="' + release + '">' + release + '</option>'
        }).join('');
        $("#id_diff_with_release").html(options);
    });
    
     $("#compare_transcript_set").click(function (e) {
     var compare_assembly = $("#id_diff_with_assembly").val();
     var compare_release = $("#id_diff_with_release").val();
     console.log(" compare_assembly " + compare_assembly + " compare_release " + compare_release);
     var compare_with_well_text='<strong> Compare Assembly: '+ compare_assembly +'  Compare Release: '+ compare_release +'. To filter type: ENST00000296468 in search box. To compare the current release set with other release set, please choose the release version from below</strong>';
   
     tark_table_compare.destroy();
     $('#loadingSpinner_compare_with').show();
     tark_table_compare = create_current_release_table("tark_datatable_compare_with","{{table_name}}",compare_assembly, compare_release);
      e.preventDefault(e);
     $('#compare_with_well').html(compare_with_well_text);
     $("#select_transcript_compare_well").replaceWith(original_state_compare_well);
     tark_table.rows( { selected: true } ).deselect();
     tark_table_compare.rows(  { selected: true } ).deselect();

     });
    
    var stable_id_current = "";
    var stable_id_version_current = "";
    tark_table.on( 'select', function ( e, dt, type, indexes ) {
       $.map(tark_table.rows( { selected: true } ).data(), function (item) {
        stable_id_current = item.stable_id;
        stable_id_version_current = item.stable_id_version;
      });
      console.log("Current selection " + stable_id_current + " stable_id_version_current " + stable_id_version_current);
      $('#current_stable_id').html(stable_id_current);
      $('#current_stable_id_version').html(stable_id_version_current);
    });
    
    var stable_id_compare = "";
    var stable_id_version_compare = "";
    tark_table_compare.on( 'select', function ( e, dt, type, indexes ) {
       $.map(tark_table_compare.rows( { selected: true } ).data(), function (item) {
        stable_id_compare = item.stable_id;
        stable_id_version_compare = item.stable_id_version;
      });
      console.log("Compare selection " + stable_id_compare + " stable_id_version_compare " + stable_id_version_compare);
       $('#compare_stable_id').html(stable_id_compare);
       $('#compare_stable_id_version').html(stable_id_version_compare);
    });
    
      
    $("#diff_selected_transcript").click(function (e) {
      console.log("diff selected transcript clicked");
     
      e.preventDefault(e);
    });
   
  });
  </script>
{% endblock %}



{% block content %}
   <div class="container-fluid" style="padding-left:50px;padding-right:50px;">
   <div class="row">
    <div id="loadingSpinner"><strong>Loading, please wait... </strong><img id="loading-img" src="{% static '/images/ajax-loader.gif' %}"><p></p></div>
    
     <div id="assembly_release_compare_well" class="row">
     <div class="col-md-10">
    <form id="compare_form" class="form-horizontal" method="POST" action="">
    {% csrf_token %}
  	<div class="form-group">
   	<label class="control-label col-md-2" for="assembly">Assembly/Release:</label>
   	<div class="col-md-1">
    {{ form.diff_with_assembly|add_class:"form-control"}}
  	</div>
 
   	<div class="col-md-1">
      {{ form.diff_with_release|add_class:"form-control"}}
   	</div>
   	
   	<div class="col-md-2">
    <button id="compare_transcript_set" type="submit" class="btn btn-primary btn-block">Compare Transcript Sets</button>
    </div>
   	

   	<label class="control-label col-md-6">(Note: To compare the current release set with any other release set, please select the assembly/release version and click the button)</label>

  	</div>

	</form>
    </div>
    </div>
    
    
    <div class="well well-sm" style="color: #31708f;background-color: #d9edf7;border-color: #bce8f1;"><strong>Current Assembly: "{{ assembly_name }}"  Current Release: "{{ release_name }}". To filter type: ENST00000296468 in search box. </strong> </div>
    <table id="tark_datatable" class="table table-striped table-bordered compact" cellspacing="0" width="95%">
      <thead>
            <tr>
             <th></th>
             {% for fields in data_fields %}
                <th>{{ fields }}</th>
             {% endfor %}
            </tr>
      </thead>
     
    </table>
    </div>
    
    <div class="row" id="compare_with_div" style="display: none;">
    <div id="compare_with_well" class="well well-sm" style="color: #3c763d;background-color: #dff0d8;border-color: #d6e9c6;">
    <strong> Compare Assembly: "{{ assembly_name_compare }}"  Compare Release: "{{ release_name_compare }}". To filter type: ENST00000302118 in search box.</strong>
    </div>

   
    <div id="loadingSpinner_compare_with"><strong>Loading, please wait... </strong><img id="loading-img" src="{% static '/images/ajax-loader.gif' %}"><p></p></div>
    
    <table id="tark_datatable_compare_with" class="table table-striped table-bordered compact" cellspacing="0" width="95%">
      <thead>
            <tr>
             <th></th>
             {% for fields in data_fields %}
                <th>{{ fields }}</th>
             {% endfor %}
            </tr>
      </thead>
     
    </table>
    
    </div>

<hr>
<!-- Selected transcript comparison --> 
    <div id="select_transcript_compare_well" class="col-md-6">
    <table class="table table-bordered compact">
     <thead>
     <tr>

      <th>Diff</th>
      <th>Stable ID</th>
      <th>Version</th>
      <th>Assembly</th>
      <th>Release</th>
     </tr>
     </thead>
    <tr class="info">
    <td>Current Release Selected</td>
    <td id="current_stable_id"></td>
    <td id="current_stable_id_version"></td>
    <td id="current_stable_id_assembly">{{ assembly_name }}</td>
    <td id="current_stable_id_release">{{ release_name }}</td>
    </tr>
    <tr class="success">
    <td>Other Release Selected</td>
    <td id="compare_stable_id"></td>
    <td id="compare_stable_id_version"></td>
    <td id="compare_stable_id_assembly">{{ assembly_name_compare }}</td>
    <td id="compare_stable_id_release">{{ release_name_compare }}</td>
    </tr>
    </table>

    <button id="diff_selected_transcript" type="submit" class="btn btn-warning">Diff Selected Transcripts</button>


    </div>



  </div>
{% endblock %}




