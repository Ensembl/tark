{% extends "web_home.html" %}

{% load staticfiles %}
{% load add_class %}
{% load add_class %}
{% load search_result_formatter %}

{% block content %}

<script type="text/javascript" class="init">


function get_query_params(row){

            transcript_stable_id = row.find("td:nth-child(3)").text().trim(); // Finds the 3rd <td> element
            transcript_assembly = row.find("td:nth-child(4)").text().trim(); 
            transcript_source = row.find("td:nth-child(5)").text().trim();
            
            
            transcript_release = row.find("td:nth-child(6)").text().trim(); 
            transcript_releases = [];
            if (typeof transcript_release != "undefined") {
            transcript_releases = transcript_release.split(',');
            transcript_releases_trimmed = [];
            $.each(transcript_releases, function( index, value ) {
			transcript_releases_trimmed.push(value.trim());
			});
            }
            console.log(transcript_releases_trimmed);
            transcript_release = transcript_releases_trimmed.sort().pop();

            //removing e and r from release
            if(transcript_release.startsWith("e") || transcript_release.startsWith("r")){
            transcript_release = transcript_release.substring(1);
            }
            return [transcript_stable_id, transcript_assembly, transcript_source, transcript_release];
}

function get_diff_result_summary(payload_data){

       
		//initialize diff_me
        diff_me_stable_id = payload_data['transcript1_stable_id'];
        diff_me_assembly = payload_data['transcript1_assembly'];
        diff_me_source = payload_data['transcript1_source'];
        diff_me_release = payload_data['transcript1_release'];
        
        //initialize diff with
        diff_with_stable_id = payload_data['transcript2_stable_id'];
        diff_with_assembly = payload_data['transcript2_assembly'];
        diff_with_source = payload_data['transcript2_source'];
        diff_with_release = payload_data['transcript2_release'];
        

        //collect diff_me params
        console.log('diff_me_assembly ' + diff_me_assembly + ' diff_me_source ' + diff_me_source  + ' diff_me_release ' + diff_me_release  + '  diff_me_stable_id ' +  diff_me_stable_id);
        
        //collect diff_with params
        console.log('diff_with_assembly ' + diff_with_assembly + ' diff_with_source ' + diff_with_source  + ' diff_with_release ' + diff_with_release  + '  diff_with_stable_id ' +  diff_with_stable_id);

        var root_url = "/api/transcript/diff/?";
        var diff_me_url = 'diff_me_assembly=' + diff_me_assembly + '&diff_me_source=' + diff_me_source  + '&diff_me_release=' + diff_me_release  + '&diff_me_stable_id=' + diff_me_stable_id;
        var diff_with_url = 'diff_with_assembly=' + diff_with_assembly + '&diff_with_source=' + diff_with_source  + '&diff_with_release=' + diff_with_release  + '&diff_with_stable_id=' + diff_with_stable_id;
        
        var get_url = root_url + diff_me_url + '&' + diff_with_url;
        get_url = get_url + "&render_as_string=True";
        var header_div = '<div id="current_well" class="well well-sm text-center" style="padding:5px;background-color: #d9edf7 !important;">' + 
        				 '<strong>TRANSCRIPT DIFF SUMMARY REPORT</strong>' +
         				'<button type="button" id="close_diff_report" class="btn btn-default btn-sm" style="float:right;padding: 5px; font-size: 10px; line-height: 1.0;"><span class="glyphicon glyphicon-remove"></span> Close</button></div>';
        $.get(get_url, function(diff_data, status){
    		gene_table = diff_data["gene"];
    		transcript_table = diff_data["transcript"];
    		translation_table = diff_data["translation"];

    		$('#summary_diff_qs1_qs2').html(header_div +  transcript_table + gene_table + translation_table);
    		$("#loadingSpinner_qs1_qs2").hide();
 		});

}//end get_diff_result_summary





$(document).ready(function() {

    var search_table = $('#search_result_table').DataTable(
    { "order": [],
    "columnDefs": [ {
      "targets"  : 'no-sort',
      "orderable": false,
    	}],
    	"language": {
        "emptyTable": "No results found for query <strong>{{search_identifier }}</strong>. Please try again with different identifier or without the version."
        }
    });
    
    $('#loadingSpinner_qs1_qs2').hide();
       
    var payload_data = {};
    var transcript1_stable_id = null;
    var transcript1_assembly = null;
    var transcript1_source = null;
    var transcript1_release = null;
    $('#search_result_table tbody').on('click', 'input[name*="transcript1"]', function(e){
        if( $(this).is(":checked") ){ // check if the radio is checked
            var row = $(this).parent().parent();
            
            [transcript1_stable_id, transcript1_assembly, transcript1_source, transcript1_release] = get_query_params(row);
            payload_data['transcript1_stable_id'] = transcript1_stable_id;
      		payload_data['transcript1_assembly'] = transcript1_assembly;
      		payload_data['transcript1_source'] = transcript1_source;
      		payload_data['transcript1_release'] = transcript1_release;
                        
            console.log(transcript1_stable_id);
            console.log(transcript1_assembly);
            console.log(transcript1_source);
            console.log(transcript1_release);
        }
    });
    
     var transcript2_stable_id = null;
     var transcript2_assembly = null;
     var transcript2_source = null;
     var transcript2_release = null;

     $('#search_result_table tbody').on('click', 'input[name*="transcript2"]', function(e){
        if( $(this).is(":checked") ){ // check if the radio is checked
            var row = $(this).parent().parent();   
            [transcript2_stable_id, transcript2_assembly, transcript2_source, transcript2_release] = get_query_params(row);
            
                 
      		payload_data['transcript2_stable_id'] = transcript2_stable_id;
      		payload_data['transcript2_assembly'] = transcript2_assembly;
      		payload_data['transcript2_source'] = transcript2_source;
      		payload_data['transcript2_release'] = transcript2_release;
            
            console.log(transcript2_stable_id);
            console.log(transcript2_assembly);
            console.log(transcript2_source);
            console.log(transcript2_release);
        }
    });
    
    var payload_data;
    $("#search_diff_transcript").click(function (e) {

	  $("#loadingSpinner_qs1_qs2").show();
	  //$("#summary_diff_qs1_qs2").empty();
      console.log("diff  transcript clicked");
      console.log(" Selected transcripts ");
      console.log(" First transcript " + transcript1_stable_id);
      console.log(" Second transcript " + transcript2_stable_id);
      
      if(transcript1_stable_id && transcript2_stable_id){
      console.log("Two transcripts selected");
      get_diff_result_summary(payload_data);
       }else{
       console.log("Two transcripts NOT selected");
       $('#myModal').modal('show');
      }
       
      });
    
    
    
    
    // Add event listener for opening and closing details
    $('#search_result_table tbody').on('click', 'td.details-control', function () {
        var tr = $(this).closest('tr');
        var row = search_table.row( tr );
 
        if ( row.child.isShown() ) {
            // This row is already open - close it
            row.child.hide();
            tr.removeClass('shown');
        }
        else {
            // Open this row
            row.child( format(row.data()) ).show();
            tr.addClass('shown');
        }
    } );
} );


	</script>

<div class="container" style="padding-top:20px;">

<!-- Info -->
<div class="panel panel-info ">
  <div class="panel-heading"><i class="glyphicon glyphicon-info-sign"></i> <strong>Search Results</strong></div>
  <div class="panel-body">

  <table id="search_result_table" class="table table-striped table-bordered table-responsive table-condensed text-center">
 <thead>
  <tr>
     <th class="text-center" data-sortable="false">T1</th>
     <th class="text-center" data-sortable="false">T2</th>
     <th class="text-center" data-sortable="true">Transcript StableID</th>
     <th class="text-center" data-sortable="true">Assembly</th>
     <th class="text-center" data-sortable="true">Source</th>
     <th class="text-center" data-sortable="true">ReleaseSet</th>
     <th class="text-center" data-sortable="true">Region</th>
     <th class="text-center" data-sortable="true">Start</th>
     <th class="text-center" data-sortable="true">End</th>
     <th class="text-center" data-sortable="true">Strand</th>
     <th class="text-center" data-sortable="true">HGNC</th>
     <!--th class="text-center" data-sortable="true">Exons</th-->
     <!--th class="text-center" data-sortable="true">Details</th-->
  </tr>
 </thead>
    {% for result in search_result %}
      <tr>
      <td><input type="radio" name="transcript1"></td>
      <td><input type="radio" name="transcript2"></td>
      <td><a target="_blank" href="http://www.ensembl.org/Homo_sapiens/Transcript/Summary?db=core;t={{result.stable_id}}">{{result.stable_id}}.{{result.stable_id_version}}</a></td>
      
       {% if result.transcript_release_set|get_values_as_list:"assembly" == "GRCh38"%}
        <td>{{result.transcript_release_set|get_values_as_list:"assembly"}}</td>
       {% else %}
        <td class="text-danger">{{result.transcript_release_set|get_values_as_list:"assembly"}}</td>
       {% endif %}
       
        {% if result.transcript_release_set|get_values_as_list:"source" == "Ensembl"%}
         <td>{{result.transcript_release_set|get_values_as_list:"source"}}</td>
       {% else %}
        <td class="text-success">{{result.transcript_release_set|get_values_as_list:"source"}}</td>
       {% endif %}
      
    
      
      {% with result.transcript_release_set|get_release_as_list:"shortname" as releases %}
      <td>
      {% if result.transcript_release_set|get_values_as_list:"source" == "Ensembl"%}
	      {%if releases|length == 1 %}
	      <a target="_blank" href="http://e{{releases.0}}.ensembl.org">e{{releases.0}}</a>
	      {% else %}
	      {% for release in releases %}
	      <a target="_blank" href="http://e{{release}}.ensembl.org">e{{release}}</a>
		      {% if forloop.counter <  releases|length %}
		      ,
		      {% endif %}
	      {% endfor %}
	      {% endif %}
      {% else %}
      	 {%if releases|length == 1 %}
	      <a target="_blank" href="https://www.ncbi.nlm.nih.gov/refseq/">{{releases.0}}</a>
	      {% else %}
	      {% for release in releases %}
	      <a target="_blank" href="https://www.ncbi.nlm.nih.gov/refseq/">{{release}}</a>
	      	{% if forloop.counter <  releases|length %}
		      ,
		    {% endif %}
	      {% endfor %}
	      {% endif %}
      {% endif %}
      </td>
      {% endwith %}
      <td>{{result.loc_region}}</td>
      <td>{{result.loc_start}}</td>
      <td>{{result.loc_end}}</td>
      <td>{{result.loc_strand}}</td>
      <td><a target="_blank" href="http://www.ensembl.org/Homo_sapiens/Gene/Summary?db=core;g={{result.genes|get_values_as_list:'hgnc'}}">{{result.genes|get_values_as_list:"hgnc"}}</a></td>
      <!--
      {% with result.exons|get_values_as_list:"stable_id_exon" as exons %}
      <td>{{exons |linebreaks}}</td>
      {% endwith %}
      <td class="details-control"></td>
      -->
      </tr>
    {% endfor %}

  
  </table>
  <button type="submit" id="search_diff_transcript" class="btn btn-info">Diff Transcripts</button>
  <a id="search_button" class="btn btn-primary" href="/web/search/">New Search</a>
  <!-- Modal -->
  <div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header" style="background-color:#dc3545;color:#fff">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Warning!</h4>
        </div>
        <div class="modal-body">
          <p>Please select two transcripts to compare.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>
  
 </div>
 
 <!--summary-->
 <div id="loadingSpinner_qs1_qs2"><strong>Loading, please wait... </strong><img id="loading-img" src="{% static '/images/ajax-loader.gif' %}"><p></p></div>
 <div id="summary_diff_qs1_qs2"> 
  
 </div>
 
</div>


 
 

{% endblock %}