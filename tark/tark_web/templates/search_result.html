{% extends "web_home.html" %}

{% load staticfiles %}
{% load add_class %}
{% load search_result_formatter %}

{% block content %}

<script type="text/javascript" class="init">


function get_query_params(row){

            transcript_stable_id = row.find("td:nth-child(3)").text().trim(); // Finds the 3rd <td> element
            transcript_assembly = row.find("td:nth-child(4)").text().trim(); 
            transcript_source = row.find("td:nth-child(5)").text().trim();
            
            
            transcript_release = row.find("td:nth-child(7)").text().trim(); 
            transcript_releases = [];
            if (typeof transcript_release != "undefined") {
            transcript_releases = transcript_release.split('-');
            transcript_releases_trimmed = [];
            $.each(transcript_releases, function( index, value ) {
			transcript_releases_trimmed.push(value.trim());
			});
            }
            console.log(transcript_releases_trimmed);
            transcript_release = transcript_releases_trimmed.sort().pop();
			console.log(transcript_release);

            //removing e and r from release
            if(transcript_release.startsWith("e")){
            transcript_release = transcript_release.substring(1,4);
            //console.log(' From e ' + transcript_release);
            }else if (transcript_release.startsWith("r")){
            transcript_release = transcript_release.substring(1,4);
            //console.log('From r ' + transcript_release)
            }
            else{
            transcript_release = transcript_release.substring(0,2);
            }
            //console.log(transcript_release);
            return [transcript_stable_id, transcript_assembly, transcript_source, transcript_release];
}

function get_diff_result_summary(payload_data){

       
		//initialize diff_me
        diff_me_stable_id = payload_data['transcript1_stable_id'];
        diff_me_assembly = payload_data['transcript1_assembly'];
        diff_me_source = payload_data['transcript1_source'];
        diff_me_release = payload_data['transcript1_release'];
        
        //initialize diff with
        diff_with_stable_id = payload_data['transcript2_stable_id'];
        diff_with_assembly = payload_data['transcript2_assembly'];
        diff_with_source = payload_data['transcript2_source'];
        diff_with_release = payload_data['transcript2_release'];
        

        //collect diff_me params
        console.log('diff_me_assembly ' + diff_me_assembly + ' diff_me_source ' + diff_me_source  + ' diff_me_release ' + diff_me_release  + '  diff_me_stable_id ' +  diff_me_stable_id);
        
        //collect diff_with params
        console.log('diff_with_assembly ' + diff_with_assembly + ' diff_with_source ' + diff_with_source  + ' diff_with_release ' + diff_with_release  + '  diff_with_stable_id ' +  diff_with_stable_id);

        var root_url = "/api/transcript/diff/?";
        var diff_me_url = 'diff_me_assembly=' + diff_me_assembly + '&diff_me_source=' + diff_me_source  + '&diff_me_release=' + diff_me_release  + '&diff_me_stable_id=' + diff_me_stable_id;
        var diff_with_url = 'diff_with_assembly=' + diff_with_assembly + '&diff_with_source=' + diff_with_source  + '&diff_with_release=' + diff_with_release  + '&diff_with_stable_id=' + diff_with_stable_id;
        
        var get_url = root_url + diff_me_url + '&' + diff_with_url;
        get_url = get_url + "&render_as_string=True";
        var header_div = '<div id="current_well" class="well well-sm text-center" style="padding:5px;background-color: #d9edf7 !important;">' + 
        				 '<strong>TRANSCRIPT COMPARISON SUMMARY REPORT</strong>' +
         				'<button type="submit" id="close_diff_report" class="btn btn-default btn-sm" style="float:right;padding: 5px; font-size: 10px; line-height: 1.0;"><span class="glyphicon glyphicon-remove"></span> Close</button></div>';
        $.get(get_url, function(diff_data, status){
    		gene_table = diff_data["gene"];
    		transcript_table = diff_data["transcript"];
    		translation_table = diff_data["translation"];
    		exonset_table = diff_data["exonset"];

    		$('#summary_diff_qs1_qs2').html(header_div +  transcript_table + gene_table + translation_table + exonset_table);
    		$("#loadingSpinner_qs1_qs2").hide();
 		});

}//end get_diff_result_summary


function get_payload_data(row, transcript){
	payload_data = {};
  [transcript_stable_id, transcript_assembly, transcript_source, transcript_release] = get_query_params(row);
            payload_data[transcript + '_stable_id'] = transcript_stable_id;
      		payload_data[transcript + '_assembly'] = transcript_assembly;
      		payload_data[transcript + '_source'] = transcript_source;
      		payload_data[transcript + '_release'] = transcript_release;
      		console.log("===start get_payload_data ==");
      		console.log(payload_data);
      		console.log("===end get_payload_data ==");
      		
			return payload_data;
}

$(document).ready(function() {
  
    var search_table = $('#search_result_table').DataTable(
    { 
      dom: 'lBfrtip',
      "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
      "pageLength": 10,
      "buttons": [ 
       { extend: 'copy', text: 'COPY', exportOptions: { columns: ':visible', rows: ':visible'}}, 
       { extend: 'csv', text: 'CSV', exportOptions: { columns: ':visible', rows: ':visible' }}, 
       { extend: 'excel', text: 'Excel', exportOptions: { columns: ':visible', rows: ':visible' }}, 
       { extend: 'pdf', text: 'PDF', exportOptions:{ columns: ':visible', rows: ':visible' }}, 
        'colvis'
       ],
     "initComplete": function(settings){
  
            /* Apply the tooltips */
            $('#search_result_table thead th[title]').tooltip(
            {
               "container": 'body'
            });          
        },
     
    "order": [[ 10, "desc" ], [ 3, "desc" ], [ 5, "desc" ]],
    "columnDefs": [ {
      "targets"  : 'no-sort',
      "orderable": false,
    	}],
    	"language": {
        "emptyTable": "No results found for query <strong>{{search_identifier }}</strong>. Please try again with different identifier or without the version.",
        "search": "<strong>Filter results:</strong> "
        }
    });
    
    $('#loadingSpinner_qs1_qs2').hide();
     
     var payload_data = {};
     var payload_data_tr1 = {};

    $('#search_result_table tbody').on('click', 'input[name*="transcript1"]', function(e){
        if( $(this).is(":checked") ){ // check if the radio is checked
            var row = $(this).parent().parent();
            payload_data_tr1 = get_payload_data(row, 'transcript1');
         }
    });
    
    var payload_data_tr2 = {};
     $('#search_result_table tbody').on('click', 'input[name*="transcript2"]', function(e){
        if( $(this).is(":checked") ){ // check if the radio is checked
            var row = $(this).parent().parent();   
            payload_data_tr2 = get_payload_data(row, 'transcript2');
        }
    });
    
    
    var payload_data ={};
    $("#search_diff_transcript").click(function (e) {
         payload_data = Object.assign({}, payload_data_tr1, payload_data_tr2);
        var transcript1_stable_id = payload_data['transcript1_stable_id'];
        var transcript2_stable_id = payload_data['transcript2_stable_id'];
       
      if(transcript1_stable_id && transcript2_stable_id){
      console.log("Two transcripts selected");
       $("#loadingSpinner_qs1_qs2").show();
      get_diff_result_summary(payload_data);
       }else{
       console.log("Two transcripts NOT selected");
       $('#myModal').modal('show');
      }
      });

 	// Add event listener for closing result table
 	$("#summary_diff_qs1_qs2").on("click", "#close_diff_report", function () {
       $("#summary_diff_qs1_qs2").empty();
     });
         
    
   });

	</script>

<div class="container-fluid" style="padding-top:20px;">

<!-- Info -->
<div class="panel panel-info ">
  <div class="panel-heading"><i class="glyphicon glyphicon-info-sign"></i> <strong>Search Results: </strong> 
 To see the difference between two transcripts, select the two transcripts (T1 and T2) and click on "Compare Transcripts" button below.
  </div>
  <div class="panel-body">

  <table id="search_result_table" class="table table-striped table-bordered table-responsive table-condensed text-center">
 <thead>
  <tr>
     <th class="text-center" data-sortable="false">T1</th>
     <th class="text-center" data-sortable="false">T2</th>
     <th class="text-center" data-sortable="true">Transcript StableID</th>
     <th class="text-center" data-sortable="true">Assembly</th>
     <th class="text-center" data-sortable="true">Source</th>
     <th class="text-center" data-sortable="true">From Release</th>
     <th class="text-center" data-sortable="true">To Release</th>
     <th class="text-center" data-sortable="true">Region</th>
     <th class="text-center" data-sortable="true">Start</th>
     <th class="text-center" data-sortable="true">End</th>
     <th class="text-center" data-sortable="true" title="Closest match from other source">Match</th>
     <th class="text-center" data-sortable="true" title="Match type">TYPE</th>
     <th class="text-center" data-sortable="true">Symbol</th>

  </tr>
 </thead>
    {% for result in search_result %}
      <tr>
      <td><input type="radio" name="transcript1"></td>
      <td><input type="radio" name="transcript2"></td>
      <td>
       <a href="/web/transcript_details/{{result.stable_id}}.{{result.stable_id_version}}/{{search_identifier}}">{{result.stable_id}}.{{result.stable_id_version}}</a>
      </td>
      
       <!--assembly -->
       {% if result.transcript_release_set|get_values_as_list:"assembly" == "GRCh38"%}
        <td>{{result.transcript_release_set|get_values_as_list:"assembly"}}</td>
       {% else %}
        <td class="text-danger">{{result.transcript_release_set|get_values_as_list:"assembly"}}</td>
       {% endif %}
       
        <!--source -->
        {% if result.transcript_release_set|get_values_as_list:"source" == "Ensembl"%}
         <td>{{result.transcript_release_set|get_values_as_list:"source"}}</td>
       {% else %}
        <td class="text-success">{{result.transcript_release_set|get_values_as_list:"source"}}</td>
       {% endif %}
      
      <!--release_set -->
       {% if result.transcript_release_set|get_values_as_list:"source" == "Ensembl" or result.transcript_release_set|get_values_as_list:"source" == "LRG"%}
       {% with result.transcript_release_set|format_release_set:"ensembl" as release_date %}
      <td>
       <a target="_blank" href="http://e{{release_date.min_release}}.ensembl.org/Homo_sapiens/Transcript/Summary?db=core;t={{result.stable_id}}.{{result.stable_id_version}}">
      {{release_date.min_release_datename_value}}
      </a>
      </td>
      <td>
       <a target="_blank" href="http://e{{release_date.max_release}}.ensembl.org/Homo_sapiens/Transcript/Summary?db=core;t={{result.stable_id}}.{{result.stable_id_version}}">
      {{release_date.max_release_datename_value}}
      </a>
      </td>
      {% endwith %}
      {% else %}
       {% with result.transcript_release_set|format_release_set:"refseq" as release_date %}
      <td>
       <a target="_blank" href="https://www.ncbi.nlm.nih.gov/nuccore/{{result.stable_id}}">	
      {{release_date.min_release_datename_value}}
      </a>
      </td>
      <td>
       <a target="_blank" href="https://www.ncbi.nlm.nih.gov/nuccore/{{result.stable_id}}">	
      {{release_date.max_release_datename_value}}
      </a>
      </td>
      {% endwith %}
      {% endif %}
       
      <td>{{result.loc_region}}</td>
      <td>{{result.loc_start}}</td>
      <td>{{result.loc_end}}</td>
      <td>{{result.mane_transcript}}</td>
      <td>{{result.mane_transcript_type}}</td>
      <td><a href="/web/search/?identifier={{result.genes|get_values_as_list:"name"}}">{{result.genes|get_values_as_list:"name"}}</a></td>
       </tr>
    {% endfor %}

  
  </table>
  <button type="submit" id="search_diff_transcript" class="btn btn-info">Compare Transcripts</button>
  <a id="search_button" class="btn btn-primary" href="/">New Search</a>
  <!-- Modal -->
  <div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header" style="background-color:#dc3545;color:#fff">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Warning!</h4>
        </div>
        <div class="modal-body">
          <p>Please select two transcripts to compare.</p>
        </div>
         <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>
  
 </div>
 
 <!--summary-->
 <div id="loadingSpinner_qs1_qs2"><strong>Loading, please wait... </strong><img id="loading-img" src="{% static '/images/ajax-loader.gif' %}"><p></p></div>
 <div id="summary_diff_qs1_qs2">  </div>
 
</div>


 
 

{% endblock %}